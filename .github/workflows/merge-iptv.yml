name: è‡ªåŠ¨åˆå¹¶IPTVåˆ—è¡¨

on:
  schedule:
    # æ¯10åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '*/10 * * * *'
  # æ·»åŠ æ‰‹åŠ¨è§¦å‘æŒ‰é’®
  workflow_dispatch:
  # å½“æœ¬æ–‡ä»¶è¢«ä¿®æ”¹æ—¶ä¹Ÿè§¦å‘
  push:
    paths:
      - '.github/workflows/merge-iptv.yml'

jobs:
  merge-iptv:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: 2. ä¸‹è½½ä¸¤ä¸ªæºæ–‡ä»¶
        run: |
          # ä¸‹è½½CCTVåˆ—è¡¨
          curl -s -L -o cctv.m3u "https://raw.githubusercontent.com/liniani/BRTV-Live-M3U8/refs/heads/main/cctv.m3u"
          echo "âœ… CCTVåˆ—è¡¨ä¸‹è½½å®Œæˆ"
          
          # ä¸‹è½½IPTVåˆ—è¡¨  
          curl -s -L -o iptv.m3u "https://raw.githubusercontent.com/empyoung/BRTV-Live-M3U8/refs/heads/main/iptv.m3u"
          echo "âœ… IPTVåˆ—è¡¨ä¸‹è½½å®Œæˆ"
          
      - name: 3. æ™ºèƒ½åˆå¹¶M3Uæ–‡ä»¶
        run: |
          # è·å–å½“å‰æ—¶é—´
          CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          
          # åˆ›å»ºæ–°æ–‡ä»¶ï¼Œæ·»åŠ M3Uå¤´éƒ¨ä¿¡æ¯
          echo "#EXTM3U" > 2026IPTV.m3u
          echo "# Generated by Auto-Merger at $CURRENT_TIME" >> 2026IPTV.m3u
          echo "# Source 1: liniani/BRTV-Live-M3U8 (CCTV)" >> 2026IPTV.m3u
          echo "# Source 2: empyoung/BRTV-Live-M3U8 (IPTV)" >> 2026IPTV.m3u
          echo "" >> 2026IPTV.m3u
          
          # å¤„ç†ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼ˆå»é™¤å¯èƒ½çš„é‡å¤å¤´éƒ¨ï¼‰
          echo "# ğŸ  ä¸­å¤®ç”µè§†å°é¢‘é“" >> 2026IPTV.m3u
          if grep -q "^#EXTM3U" cctv.m3u; then
            # å¦‚æœæ–‡ä»¶æœ‰#EXTM3Uå¤´ï¼Œè·³è¿‡ç¬¬ä¸€è¡Œ
            tail -n +2 cctv.m3u >> 2026IPTV.m3u
          else
            cat cctv.m3u >> 2026IPTV.m3u
          fi
          
          echo "" >> 2026IPTV.m3u
          echo "# ğŸ“º åœ°æ–¹åŠæµ·å¤–é¢‘é“" >> 2026IPTV.m3u
          
          # å¤„ç†ç¬¬äºŒä¸ªæ–‡ä»¶
          if grep -q "^#EXTM3U" iptv.m3u; then
            tail -n +2 iptv.m3u >> 2026IPTV.m3u
          else
            cat iptv.m3u >> 2026IPTV.m3u
          fi
          
          # ç»Ÿè®¡è¡Œæ•°
          CCTV_COUNT=$(grep -c "^#EXTINF" cctv.m3u || echo "0")
          IPTV_COUNT=$(grep -c "^#EXTINF" iptv.m3u || echo "0")
          TOTAL=$((CCTV_COUNT + IPTV_COUNT))
          
          echo "" >> 2026IPTV.m3u
          echo "# ğŸ“Š ç»Ÿè®¡ä¿¡æ¯" >> 2026IPTV.m3u
          echo "# ä¸­å¤®ç”µè§†å°é¢‘é“æ•°: $CCTV_COUNT" >> 2026IPTV.m3u
          echo "# åœ°æ–¹åŠæµ·å¤–é¢‘é“æ•°: $IPTV_COUNT" >> 2026IPTV.m3u
          echo "# æ€»é¢‘é“æ•°: $TOTAL" >> 2026IPTV.m3u
          
          echo "ğŸ“ˆ åˆå¹¶å®Œæˆï¼šå…± $TOTAL ä¸ªé¢‘é“"
          
      - name: 4. æäº¤å¹¶æ¨é€æ–‡ä»¶
        run: |
          # é…ç½®Gitç”¨æˆ·
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
          git add 2026IPTV.m3u
          
          if git diff --staged --quiet; then
            echo "âš ï¸ æ²¡æœ‰å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            # æäº¤å¹¶æ¨é€
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°IPTVåˆ—è¡¨ [$(date '+%Y-%m-%d %H:%M')]"
            git push
            echo "âœ… å·²æäº¤å¹¶æ¨é€åˆ°ä»“åº“"
          fi
          
      - name: 5. æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        run: |
          echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶ï¼š2026IPTV.m3u"
          echo "ğŸ“ æ–‡ä»¶å¤§å°ï¼š$(wc -l < 2026IPTV.m3u) è¡Œ"
          echo "â° ä¸‹æ¬¡è‡ªåŠ¨è¿è¡Œæ—¶é—´ï¼š10åˆ†é’Ÿå"
          echo "ğŸ”— æ–‡ä»¶URLï¼šhttps://raw.githubusercontent.com/${{ github.repository }}/refs/heads/main/2026IPTV.m3u"
